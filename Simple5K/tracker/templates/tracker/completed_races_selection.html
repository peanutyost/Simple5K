{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-3 py-md-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <h1 class="text-center mb-4">Select a Completed Race</h1>
            <div class="row justify-content-center mb-4">
                <div class="col-12 col-md-6 col-lg-4">
                    <label for="race_select" class="form-label">Select Race</label>
                    <select id="race_select" class="form-select" aria-label="Select completed race">
                        <option value="">Select a race</option>
                        {% for race in completed_races %}
                        <option value="{{ race.id }}">{{ race.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="race-overview-container mt-4" role="region" aria-live="polite" aria-label="Race results"></div>
        </div>
    </div>
</div>
<script>
(function() {
    function escapeHtml(s) {
        if (s == null) return '';
        var d = document.createElement('div');
        d.textContent = String(s);
        return d.innerHTML;
    }
    var select = document.getElementById('race_select');
    var container = document.querySelector('.race-overview-container');
    if (!select || !container) return;
    select.addEventListener('change', function() {
        var raceId = select.value;
        if (!raceId) { container.innerHTML = ''; return; }
        var url = '/tracker/get_completed_race_overview/' + encodeURIComponent(raceId) + '/';
        fetch(url, { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                container.innerHTML = '';
                var h1 = document.createElement('h1');
                h1.className = 'mb-4';
                h1.textContent = data.race_name || '';
                container.appendChild(h1);
                if (data.runner_times && data.runner_times.length) {
                    var table = document.createElement('div');
                    table.className = 'table-responsive';
                    var tbl = document.createElement('table');
                    tbl.className = 'table table-bordered table-striped table-hover';
                    var thead = document.createElement('thead');
                    thead.className = 'table-light';
                    thead.innerHTML = '<tr><th scope="col">Runner</th><th scope="col">Name</th><th scope="col">Laps</th><th scope="col">Total Time</th><th scope="col">Avg Pace</th><th scope="col">Avg Speed</th><th scope="col">Place</th></tr>';
                    tbl.appendChild(thead);
                    var tbody = document.createElement('tbody');
                    data.runner_times.forEach(function(runner) {
                        var lapsHtml = '';
                        if (runner.laps && runner.laps.length) {
                            runner.laps.forEach(function(lap) {
                                lapsHtml += '<div class="mb-1">Lap ' + escapeHtml(lap.lap) + ': ' + escapeHtml(lap.duration) + ' - ' + escapeHtml(lap.average_pace) + ' - ' + escapeHtml(lap.average_speed) + ' MPH</div>';
                            });
                        }
                        var placeText = runner.place != null ? runner.place + (runner.gender === 'female' ? ' F' : runner.gender === 'male' ? ' M' : '') : 'Not Finished';
                        var tr = document.createElement('tr');
                        tr.innerHTML = '<td>' + escapeHtml(runner.number) + '</td><td>' + escapeHtml(runner.name) + '</td><td>' + lapsHtml + '</td><td>' + escapeHtml(runner.total_race_time) + '</td><td>' + escapeHtml(runner.average_pace) + '</td><td>' + escapeHtml(runner.average_speed !== 'Not Finished' ? runner.average_speed + ' MPH' : 'Not Finished') + '</td><td>' + escapeHtml(placeText) + '</td>';
                        tbody.appendChild(tr);
                    });
                    tbl.appendChild(tbody);
                    table.appendChild(tbl);
                    container.appendChild(table);
                }
            })
            .catch(function() {
                container.innerHTML = '<div class="alert alert-danger" role="alert">An error occurred. Please try again.</div>';
            });
    });
})();
</script>
{% endblock %}
