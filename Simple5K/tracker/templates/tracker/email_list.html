{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-3 py-md-4">
    <div class="row">
        <div class="col-12 col-lg-8">
            <h1 class="mb-4">Send Email to Runners</h1>
            <p class="text-muted">Select one or more races, enter subject and message. Each runner receives a separate email (one per person for general email; one per unpaid entry for payment reminders so each link is correct). Emails are sent in the background and throttled to stay within provider limits.</p>
            <form id="send-email-form" method="post" action="{% url 'tracker:email_list' %}">
                {% csrf_token %}
                <!-- Do not use name="action" - it shadows form.action and breaks the submit URL -->
                <div class="mb-3">
                    <label for="race-select" class="form-label">Race(s) <span class="text-danger">*</span></label>
                    <select id="race-select" name="race_ids" class="form-select" multiple size="8" aria-label="Select one or more races">
                        {% for race_obj in races %}
                        <option value="{{ race_obj.id }}">{{ race_obj.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="form-text small text-muted">Hold Ctrl (Windows) or Cmd (Mac) to select multiple races.</p>
                    <div id="recipient-count" class="form-text text-muted" aria-live="polite"></div>
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="unpaid-reminder" name="unpaid_reminder" value="1" aria-describedby="unpaid-reminder-help">
                        <label class="form-check-label" for="unpaid-reminder">Send payment reminders only to unpaid runners for the selected race(s)</label>
                    </div>
                    <p id="unpaid-reminder-help" class="form-text small text-muted">When checked, each unpaid entry gets one email with that entry’s payment link. Otherwise, the list is deduplicated by email (one email per person).</p>
                </div>
                <div class="mb-3">
                    <label for="email-subject" class="form-label">Subject <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="email-subject" name="subject" maxlength="255" required placeholder="e.g. Race day reminder">
                </div>
                <div class="mb-3">
                    <label for="email-body" class="form-label">Message</label>
                    <textarea class="form-control" id="email-body" name="body" rows="10" placeholder="Your message to runners..."></textarea>
                    <p class="form-text small text-muted">A line will be appended: &quot;This is an unmonitored email account. Please do not reply.&quot;</p>
                </div>
                <button type="submit" class="btn btn-primary" id="send-btn">Send email</button>
            </form>
            <div id="send-result" class="mt-3" role="alert" aria-live="polite"></div>
            {% if recent_jobs %}
            <div class="mt-4">
                <h2 class="h6 text-muted mb-2">Recent send jobs</h2>
                <p class="small text-muted">Emails are sent in the background. If a job stays on &quot;Sending&quot;, open the Send Email page again (to start the worker), or run <code>python manage.py reset_stuck_email_jobs</code>, or in Admin → EmailSendJob use the action &quot;Reset stuck (Sending → Failed)&quot;.</p>
                <ul class="list-group list-group-flush small">
                    {% for job in recent_jobs %}
                    <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                        <span>{{ job.race.name }} — {{ job.subject|truncatechars:40 }}</span>
                        <span>
                            {% if job.status == 'completed' %}<span class="badge bg-success">Completed</span>
                            {% elif job.status == 'failed' %}<span class="badge bg-danger" title="{{ job.error_message|default:'' }}">Failed</span>
                            {% elif job.status == 'sending' %}<span class="badge bg-warning text-dark">Sending</span>
                            {% else %}<span class="badge bg-secondary">Queued</span>{% endif %}
                            <span class="text-muted">{{ job.created_at|timesince }} ago</span>
                        </span>
                    </li>
                    {% if job.status == 'failed' and job.error_message %}<li class="list-group-item small text-danger px-0">{{ job.error_message|truncatechars:120 }}</li>{% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
(function() {
    var form = document.getElementById('send-email-form');
    var raceSelect = document.getElementById('race-select');
    var sendResult = document.getElementById('send-result');
    var sendBtn = document.getElementById('send-btn');
    var csrfInput = form && form.querySelector('input[name="csrfmiddlewaretoken"]');

    function getCsrfToken() {
        var name = 'csrftoken';
        var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) return match[2];
        return csrfInput ? csrfInput.value : '';
    }

    function setResult(html, isError) {
        if (!sendResult) return;
        sendResult.innerHTML = html;
        sendResult.className = 'mt-3 alert ' + (isError ? 'alert-danger' : 'alert-success');
    }

    function escapeHtml(s) {
        if (s == null) return '';
        var d = document.createElement('div');
        d.textContent = String(s);
        return d.innerHTML;
    }

    function getSelectedRaceIds() {
        if (!raceSelect || !raceSelect.options) return [];
        var ids = [];
        for (var i = 0; i < raceSelect.options.length; i++) {
            if (raceSelect.options[i].selected && raceSelect.options[i].value) ids.push(raceSelect.options[i].value);
        }
        return ids;
    }

    function updateRecipientCount() {
        var countEl = document.getElementById('recipient-count');
        var ids = getSelectedRaceIds();
        if (!countEl || ids.length === 0) {
            if (countEl) countEl.textContent = '';
            return;
        }
        countEl.textContent = 'Loading…';
        var xhr = new XMLHttpRequest();
        xhr.open('POST', document.getElementById('send-email-form').action || window.location.href, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', getCsrfToken());
        xhr.onreadystatechange = function() {
            if (xhr.readyState !== 4) return;
            try {
                var data = JSON.parse(xhr.responseText);
                var n = data.count != null ? data.count : 0;
                var unpaidReminder = document.getElementById('unpaid-reminder') && document.getElementById('unpaid-reminder').checked;
                if (unpaidReminder) {
                    countEl.textContent = n === 0 ? 'No unpaid runners with email for selected race(s).' : (n + ' unpaid runner(s) will receive a reminder with payment link.');
                } else {
                    countEl.textContent = n === 0 ? 'No runners with email for selected race(s).' : (n + ' runner(s) will receive this email.');
                }
            } catch (e) {
                countEl.textContent = '';
            }
        };
        var unpaidReminder = document.getElementById('unpaid-reminder') && document.getElementById('unpaid-reminder').checked;
        var body = 'action=recipient_count&csrfmiddlewaretoken=' + encodeURIComponent(getCsrfToken());
        if (unpaidReminder) body += '&unpaid_reminder=1';
        ids.forEach(function(id) { body += '&race_ids=' + encodeURIComponent(id); });
        xhr.send(body);
    }

    if (raceSelect) raceSelect.addEventListener('change', updateRecipientCount);
    var unpaidReminderEl = document.getElementById('unpaid-reminder');
    if (unpaidReminderEl) unpaidReminderEl.addEventListener('change', updateRecipientCount);

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var ids = getSelectedRaceIds();
            if (ids.length === 0) {
                setResult('Please select at least one race.', true);
                return;
            }
            var subject = document.getElementById('email-subject');
            if (!subject || !subject.value.trim()) {
                setResult('Subject is required.', true);
                return;
            }
            sendResult.innerHTML = '';
            if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Queuing…'; }
            var unpaidReminder = document.getElementById('unpaid-reminder') && document.getElementById('unpaid-reminder').checked;
            var body = 'action=send&subject=' + encodeURIComponent((subject && subject.value) || '') +
                '&body=' + encodeURIComponent((document.getElementById('email-body') && document.getElementById('email-body').value) || '') +
                (unpaidReminder ? '&unpaid_reminder=1' : '') +
                '&csrfmiddlewaretoken=' + encodeURIComponent(getCsrfToken());
            ids.forEach(function(id) { body += '&race_ids=' + encodeURIComponent(id); });
            var xhr = new XMLHttpRequest();
            xhr.open('POST', form.action || window.location.href, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('X-CSRFToken', getCsrfToken());
            xhr.onreadystatechange = function() {
                if (xhr.readyState !== 4) return;
                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send email'; }
                var msg = '';
                try {
                    var data = JSON.parse(xhr.responseText);
                    if (data.success && data.message) {
                        setResult(escapeHtml(data.message), false);
                        form.reset();
                        for (var i = 0; i < raceSelect.options.length; i++) raceSelect.options[i].selected = false;
                        var rc = document.getElementById('recipient-count');
                        if (rc) rc.textContent = '';
                        return;
                    }
                    msg = data.error || 'Send failed.';
                } catch (err) {
                    if (xhr.status >= 400 && xhr.responseText) {
                        try {
                            var errData = JSON.parse(xhr.responseText);
                            if (errData.error) msg = errData.error;
                        } catch (e2) {}
                    }
                    if (!msg) msg = 'Server error (status ' + (xhr.status || '?') + '). If 403, try refreshing the page and sending again.';
                }
                setResult(escapeHtml(msg), true);
            };
            xhr.send(body);
        });
    }
})();
</script>
{% endblock %}
