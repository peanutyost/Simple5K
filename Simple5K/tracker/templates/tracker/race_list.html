{% extends "base.html" %}
{% load static %}
{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=BioRhyme:wght@200..800&display=swap');
</style>

{% if banners %}
<div class="container">
    <div class="row justify-content-center mt-3 mt-md-5">
        <div class="col-12">
            <div class="banner-container min-vh-25 d-flex align-items-center rounded" style="min-height: 280px;">
                {% for banner in banners %}
                <div class="banner w-100 text-center text-dark rounded" style="background-color: {{ banner.background_color }};">
                    <div class="banner-content p-3 p-md-4">
                        <h1 class="display-5 display-md-4 mb-3 mb-md-4">{{ banner.title }}</h1>
                        <p class="lead mb-4 mb-md-5">{{ banner.subtitle }}</p>
                        {% if banner.image %}
                        <img src="{{ banner.image.url }}" alt="{{ banner.title|escape }}" class="img-fluid mx-auto d-block rounded mb-3 mb-md-4" style="max-width: 100%; width: 300px;">
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="container mt-4">
    <h1 class="text-center mb-4" style="font-family: 'BioRhyme', serif;">Upcoming Races</h1>

    <div id="active-race-alert" class="alert alert-warning text-center d-none" role="alert">
        There is currently an active race: <strong id="active-race-name"></strong>! <a href="{% url 'tracker:race-overview' %}" class="alert-link">Go to Race Tracker</a>
    </div>

    <div id="race-container" class="row g-3 g-md-4 justify-content-center"></div>

    <div id="no-races-message" class="alert alert-info d-none text-center" role="status">
        There are currently no upcoming races. <a href="{% url 'tracker:completed_races_selection' %}" class="btn btn-secondary">View Past Races</a>
    </div>
</div>

<script>
(function() {
    var raceOverviewUrl = '{% url "tracker:race-overview" %}';
    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = String(s);
        return div.innerHTML;
    }
    function updateRaces() {
        fetch('/race-countdown/?_=' + Date.now(), { credentials: 'same-origin' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var raceContainer = document.getElementById('race-container');
                var noRacesMessage = document.getElementById('no-races-message');
                var activeRaceAlert = document.getElementById('active-race-alert');
                var activeRaceName = document.getElementById('active-race-name');

                raceContainer.innerHTML = '';
                noRacesMessage.classList.add('d-none');
                activeRaceAlert.classList.add('d-none');

                if (data.active_race) {
                    activeRaceName.textContent = data.active_race.name;
                    activeRaceAlert.classList.remove('d-none');
                }
                if (!data.races || data.races.length === 0) {
                    noRacesMessage.classList.remove('d-none');
                    return;
                }
                data.races.forEach(function(race) {
                    var col = document.createElement('div');
                    col.className = 'col-12 col-md-6 col-lg-4';
                    var remaining = race.remaining || {};
                    var name = escapeHtml(race.name);
                    var distance = escapeHtml(race.distance);
                    var lapsCount = escapeHtml(race.laps_count);
                    var entryFee = escapeHtml(race.entry_fee);
                    var d = remaining.days || 0, h = remaining.hours || 0, m = remaining.minutes || 0, s = remaining.seconds || 0;
                    var done = (d === 0 && h === 0 && m === 0 && s === 0);
                    col.innerHTML =
                        '<div class="card h-100 border-2 border-dark rounded-2" style="background-color: rgba(180,121,43,0.7);">' +
                        '<div class="card-body text-center p-3 p-md-4">' +
                        '<h3 class="card-title h5 mb-3">' + name + '</h3>' +
                        '<p class="card-text small">' +
                        '<strong>Distance:</strong> ' + distance + '<br><strong>Laps:</strong> ' + lapsCount + '<br><strong>Entry Fee:</strong> ' + entryFee +
                        '</p>' +
                        '<div class="mb-3">' +
                        '<h4 class="h6 text-white">Race Starts In:</h4>' +
                        '<span class="fs-5 fw-bold">' + d + 'd : ' + h + 'h : ' + m + 'm : ' + s + 's</span>' +
                        '</div>' +
                        (done ? '<p class="text-muted small mb-0"><a href="' + escapeHtml(raceOverviewUrl) + '" class="btn btn-primary btn-sm">View Live Races</a></p>' : '') +
                        '</div></div>';
                    raceContainer.appendChild(col);
                });
            })
            .catch(function(err) { console.error('Error:', err); });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() { updateRaces(); setInterval(updateRaces, 1000); });
    } else {
        updateRaces();
        setInterval(updateRaces, 1000);
    }
})();
</script>
{% endblock %}
