{% extends 'base.html' %}
{% load static %}
{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
<script src="{% static 'sorttable.js' %}"></script>
<div class="container py-3 py-md-4">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4">{{ race_name }}</h1>
            {% if request.user.is_authenticated %}
            <div class="row justify-content-center mb-4">
                <div class="col-12 col-md-8 col-lg-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Mark Runner as Finished</h5>
                            <form id="finishRunnerForm" method="post" action="{% url 'tracker:mark_runner_finished' %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="runner_number" class="form-label">Runner Number</label>
                                    <input type="number" class="form-control" id="runner_number" name="runner_number" min="1" required aria-required="true">
                                </div>
                                <button type="submit" class="btn btn-primary">Mark as Finished</button>
                            </form>
                            <div id="submission-response" class="mt-2" role="alert" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
            (function() {
                var form = document.getElementById('finishRunnerForm');
                var responseEl = document.getElementById('submission-response');
                var csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (form && csrfInput) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        var runnerNumber = document.getElementById('runner_number').value;
                        var xhr = new XMLHttpRequest();
                        xhr.open('POST', form.getAttribute('action'), true);
                        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                        xhr.onreadystatechange = function() {
                            if (xhr.readyState === 4) {
                                try {
                                    var data = JSON.parse(xhr.responseText);
                                    var msg = data.message || '';
                                    if (data.success) {
                                        responseEl.innerHTML = '<div class="alert alert-success">' + escapeHtml(msg) + '</div>';
                                        if (typeof location.reload === 'function') location.reload();
                                    } else {
                                        responseEl.innerHTML = '<div class="alert alert-danger">' + escapeHtml(msg) + '</div>';
                                    }
                                } catch (err) {
                                    responseEl.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                                }
                            }
                        };
                        xhr.send('runner_number=' + encodeURIComponent(runnerNumber) + '&csrfmiddlewaretoken=' + encodeURIComponent(csrfInput.value));
                    });
                }
                function escapeHtml(text) {
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                setInterval(function() { location.reload(); }, 30000);
            })();
            </script>
            {% endif %}

            <div class="table-responsive">
                <table id="raceTable" class="table table-bordered table-striped table-hover sortable">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Runner</th>
                            <th scope="col">Name</th>
                            <th scope="col">Lap : Time - Pace - Speed</th>
                            <th scope="col">Total Race Time</th>
                            <th scope="col">Average Pace</th>
                            <th scope="col">Average Speed (MPH)</th>
                            <th scope="col" data-sort="number">Finished Place</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for runner in runner_times %}
                        <tr>
                            <td>{{ runner.number }}</td>
                            <td>{{ runner.name }}</td>
                            <td>
                                {% for lap in runner.laps %}
                                <div class="mb-1">Lap {{ lap.lap }}: {{ lap.duration }} - {{ lap.average_pace }} - {{ lap.average_speed }} MPH</div>
                                {% endfor %}
                            </td>
                            <td>{% if runner.total_race_time %}{{ runner.total_race_time }}{% else %}Not Finished{% endif %}</td>
                            <td>{% if runner.average_pace %}{{ runner.average_pace }}{% else %}Not Finished{% endif %}</td>
                            <td>{% if runner.average_speed %}{{ runner.average_speed }}{% else %}Not Finished{% endif %}</td>
                            <td sorttable_customkey="{% if runner.place %}{{ runner.place }}{% else %}999999{% endif %}">
                                {% if runner.place %}
                                    {% if runner.gender == "female" %}{{ runner.place }} F{% elif runner.gender == "male" %}{{ runner.place }} M{% else %}{{ runner.place }}{% endif %}
                                {% else %}
                                    Not Finished
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
