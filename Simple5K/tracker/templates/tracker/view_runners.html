{% extends 'base.html' %}
{% load static %}
{% block content %}
<form id="csrf-form" method="post" action="" style="display: none;">{% csrf_token %}</form>
<div class="container py-3 py-md-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Runners for {{ race.name }}</h2>
            <div class="d-flex flex-wrap gap-2 mb-3">
                <a href="{% url 'tracker:select_race_runners' %}" class="btn btn-primary">Back to Race List</a>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRunnerModal" aria-label="Add runner">Add Runner</button>
            </div>
            <p class="text-muted small mb-3">Click a row to edit the runner.</p>
            <div class="table-responsive">
                <table id="runnersTable" class="table table-striped table-bordered table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" class="sortable-th" tabindex="0" role="button">Name</th>
                            <th scope="col" class="sortable-th" tabindex="0" role="button">Age</th>
                            <th scope="col" class="sortable-th" tabindex="0" role="button">Number</th>
                            <th scope="col" class="sortable-th" tabindex="0" role="button">Type</th>
                            <th scope="col" class="sortable-th" tabindex="0" role="button">Shirt Size</th>
                            <th scope="col" class="no-sort">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for runner in runners %}
                        <tr class="runner-row" data-runner-id="{{ runner.id }}"
                            data-first-name="{{ runner.first_name|escapejs }}"
                            data-last-name="{{ runner.last_name|escapejs }}"
                            data-email="{{ runner.email|escapejs }}"
                            data-age="{{ runner.age|escapejs }}"
                            data-gender="{{ runner.gender|default:''|escapejs }}"
                            data-number="{{ runner.number|default:'' }}"
                            data-type="{{ runner.type|default:''|escapejs }}"
                            data-shirt-size="{{ runner.shirt_size|escapejs }}">
                            <td class="name-cell">{{ runner.first_name }} {{ runner.last_name }}</td>
                            <td class="age-cell">{{ runner.age }}</td>
                            <td class="number-cell">{% if runner.number %}{{ runner.number }}{% else %}—{% endif %}</td>
                            <td class="type-cell">{{ runner.type|default:"—" }}</td>
                            <td class="shirt-cell">{{ runner.shirt_size }}</td>
                            <td class="actions-cell">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-runner-btn" aria-label="Edit runner">Edit</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Runner Modal -->
<div class="modal fade" id="addRunnerModal" tabindex="-1" aria-labelledby="addRunnerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRunnerModalLabel">Add Runner</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="add-runner-errors" class="alert alert-danger d-none" role="alert"></div>
                <form id="add-runner-form">
                    <div class="mb-3">
                        <label for="add-first-name" class="form-label">First name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="add-first-name" name="first_name" maxlength="50" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-last-name" class="form-label">Last name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="add-last-name" name="last_name" maxlength="50" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-email" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="add-email" name="email" maxlength="254" required>
                    </div>
                    <div class="mb-3">
                        <label for="add-age" class="form-label">Age bracket <span class="text-danger">*</span></label>
                        <select class="form-select" id="add-age" name="age" required>
                            {% for value, label in age_brackets %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-gender" class="form-label">Gender</label>
                        <select class="form-select" id="add-gender" name="gender">
                            <option value="">—</option>
                            {% for value, label in genders %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-number" class="form-label">Number</label>
                        <input type="number" class="form-control" id="add-number" name="number" min="0" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label for="add-type" class="form-label">Type</label>
                        <select class="form-select" id="add-type" name="type">
                            <option value="">—</option>
                            {% for value, label in race_types %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="add-shirt-size" class="form-label">Shirt size <span class="text-danger">*</span></label>
                        <select class="form-select" id="add-shirt-size" name="shirt_size" required>
                            {% for value, label in shirt_sizes %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="add-runner-submit">Add Runner</button>
            </div>
        </div>
    </div>
</div>

<script id="runner-choices" type="application/json">
{
  "age_brackets": [{% for value, label in age_brackets %}{"value": "{{ value|escapejs }}", "label": "{{ label|escapejs }}"}{% if not forloop.last %}, {% endif %}{% endfor %}],
  "genders": [{"value": "", "label": "—"}, {% for value, label in genders %}{"value": "{{ value|escapejs }}", "label": "{{ label|escapejs }}"}{% if not forloop.last %}, {% endif %}{% endfor %}],
  "race_types": [{"value": "", "label": "—"}, {% for value, label in race_types %}{"value": "{{ value|escapejs }}", "label": "{{ label|escapejs }}"}{% if not forloop.last %}, {% endif %}{% endfor %}],
  "shirt_sizes": [{% for value, label in shirt_sizes %}{"value": "{{ value|escapejs }}", "label": "{{ label|escapejs }}"}{% if not forloop.last %}, {% endif %}{% endfor %}]
}
</script>
<script>
(function() {
    var table = document.getElementById('runnersTable');
    if (!table || !table.tHead) return;
    var choicesEl = document.getElementById('runner-choices');
    var choices = choicesEl ? JSON.parse(choicesEl.textContent) : { age_brackets: [], genders: [], race_types: [], shirt_sizes: [] };
    var editRunnerUrl = '{% url "tracker:edit_runner" %}';
    var addRunnerUrl = '{% url "tracker:add_runner" %}';
    var currentRaceId = {{ race.id }};
    function getCsrf() {
        var x = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (x && x.value) return x.value;
        var m = document.cookie.match(/csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1].trim()) : '';
    }

    function selectOptions(opts) {
        var html = '';
        (opts || []).forEach(function(o) { html += '<option value="' + escapeAttr(o.value) + '">' + escapeHtml(o.label) + '</option>'; });
        return html;
    }
    function escapeHtml(s) {
        if (s == null) return '';
        var d = document.createElement('div');
        d.textContent = String(s);
        return d.innerHTML;
    }
    function escapeAttr(s) {
        if (s == null) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function enterEditMode(tr) {
        if (tr.classList.contains('editing')) return;
        tr.classList.add('editing');
        var id = tr.getAttribute('data-runner-id');
        var firstName = tr.getAttribute('data-first-name') || '';
        var lastName = tr.getAttribute('data-last-name') || '';
        var email = tr.getAttribute('data-email') || '';
        var age = tr.getAttribute('data-age') || '';
        var gender = tr.getAttribute('data-gender') || '';
        var number = tr.getAttribute('data-number') || '';
        var type = tr.getAttribute('data-type') || '';
        var shirt = tr.getAttribute('data-shirt-size') || '';

        tr.querySelector('.name-cell').innerHTML =
            '<input type="text" class="form-control form-control-sm edit-first" value="' + escapeAttr(firstName) + '" placeholder="First" maxlength="50"> ' +
            '<input type="text" class="form-control form-control-sm edit-last mt-1" value="' + escapeAttr(lastName) + '" placeholder="Last" maxlength="50"> ' +
            '<input type="email" class="form-control form-control-sm edit-email mt-1" value="' + escapeAttr(email) + '" placeholder="Email" maxlength="254">';
        tr.querySelector('.age-cell').innerHTML = '<select class="form-select form-select-sm edit-age">' + selectOptions(choices.age_brackets) + '</select>';
        tr.querySelector('.age-cell').querySelector('select').value = age || (choices.age_brackets[0] && choices.age_brackets[0].value);
        tr.querySelector('.number-cell').innerHTML = '<input type="number" class="form-control form-control-sm edit-number" value="' + escapeAttr(number) + '" min="0" placeholder="—">';
        tr.querySelector('.type-cell').innerHTML = '<select class="form-select form-select-sm edit-type">' + selectOptions(choices.race_types) + '</select>';
        tr.querySelector('.type-cell').querySelector('select').value = type || '';
        tr.querySelector('.shirt-cell').innerHTML = '<select class="form-select form-select-sm edit-shirt">' + selectOptions(choices.shirt_sizes) + '</select>';
        tr.querySelector('.shirt-cell').querySelector('select').value = shirt || (choices.shirt_sizes[0] && choices.shirt_sizes[0].value);
        tr.querySelector('.actions-cell').innerHTML =
            '<button type="button" class="btn btn-sm btn-success save-runner-btn me-1">Save</button>' +
            '<button type="button" class="btn btn-sm btn-secondary cancel-runner-btn">Cancel</button>';
        tr.querySelector('.save-runner-btn').addEventListener('click', function() { saveRunner(tr); });
        tr.querySelector('.cancel-runner-btn').addEventListener('click', function() { cancelEdit(tr); });
    }

    function cancelEdit(tr) {
        if (!tr.classList.contains('editing')) return;
        var firstName = tr.getAttribute('data-first-name') || '';
        var lastName = tr.getAttribute('data-last-name') || '';
        var age = tr.getAttribute('data-age') || '';
        var number = tr.getAttribute('data-number');
        var type = tr.getAttribute('data-type') || '';
        var shirt = tr.getAttribute('data-shirt-size') || '';
        tr.classList.remove('editing');
        tr.querySelector('.name-cell').textContent = (firstName + ' ' + lastName).trim() || '—';
        tr.querySelector('.age-cell').textContent = age || '—';
        tr.querySelector('.number-cell').textContent = number !== '' && number != null ? number : '—';
        tr.querySelector('.type-cell').textContent = type || '—';
        tr.querySelector('.shirt-cell').textContent = shirt || '—';
        tr.querySelector('.actions-cell').innerHTML = '<button type="button" class="btn btn-sm btn-outline-primary edit-runner-btn" aria-label="Edit runner">Edit</button>';
        tr.querySelector('.edit-runner-btn').addEventListener('click', function(e) { e.stopPropagation(); enterEditMode(tr); });
    }

    function saveRunner(tr) {
        var id = tr.getAttribute('data-runner-id');
        var first = (tr.querySelector('.edit-first') && tr.querySelector('.edit-first').value) || '';
        var last = (tr.querySelector('.edit-last') && tr.querySelector('.edit-last').value) || '';
        var email = (tr.querySelector('.edit-email') && tr.querySelector('.edit-email').value) || '';
        var age = (tr.querySelector('.edit-age') && tr.querySelector('.edit-age').value) || '';
        var numberEl = tr.querySelector('.edit-number');
        var number = numberEl && numberEl.value !== '' ? numberEl.value : null;
        var typeEl = tr.querySelector('.edit-type');
        var type = typeEl && typeEl.value !== '' ? typeEl.value : null;
        var shirtEl = tr.querySelector('.edit-shirt');
        var shirt = shirtEl ? shirtEl.value : '';

        var payload = {
            runner_id: parseInt(id, 10),
            first_name: first.trim(),
            last_name: last.trim(),
            email: email.trim(),
            age: age,
            number: number !== null ? (isNaN(parseInt(number, 10)) ? null : parseInt(number, 10)) : null,
            type: type,
            shirt_size: shirt
        };
        var btn = tr.querySelector('.save-runner-btn');
        if (btn) { btn.disabled = true; btn.textContent = 'Saving…'; }
        fetch(editRunnerUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrf(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(payload),
            credentials: 'same-origin'
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
            if (data.success && data.runner) {
                var r = data.runner;
                tr.setAttribute('data-first-name', r.first_name || '');
                tr.setAttribute('data-last-name', r.last_name || '');
                tr.setAttribute('data-email', r.email || '');
                tr.setAttribute('data-age', r.age || '');
                tr.setAttribute('data-number', r.number != null ? r.number : '');
                tr.setAttribute('data-type', r.type || '');
                tr.setAttribute('data-shirt-size', r.shirt_size || '');
                tr.classList.remove('editing');
                tr.querySelector('.name-cell').textContent = ((r.first_name || '') + ' ' + (r.last_name || '')).trim() || '—';
                tr.querySelector('.age-cell').textContent = r.age || '—';
                tr.querySelector('.number-cell').textContent = r.number != null ? r.number : '—';
                tr.querySelector('.type-cell').textContent = r.type || '—';
                tr.querySelector('.shirt-cell').textContent = r.shirt_size || '—';
                tr.querySelector('.actions-cell').innerHTML = '<button type="button" class="btn btn-sm btn-outline-primary edit-runner-btn" aria-label="Edit runner">Edit</button>';
                tr.querySelector('.edit-runner-btn').addEventListener('click', function(e) { e.stopPropagation(); enterEditMode(tr); });
            } else {
                var msg = (data.errors && data.errors.length) ? data.errors.join(' ') : 'Save failed';
                tr.querySelector('.actions-cell').innerHTML = '<span class="text-danger small">' + escapeHtml(msg) + '</span> <button type="button" class="btn btn-sm btn-secondary cancel-runner-btn ms-1">Cancel</button>';
                tr.querySelector('.cancel-runner-btn').addEventListener('click', function() { cancelEdit(tr); });
            }
        }).catch(function() {
            if (btn) { btn.disabled = false; btn.textContent = 'Save'; }
            tr.querySelector('.actions-cell').innerHTML = '<span class="text-danger small">Network error</span> <button type="button" class="btn btn-sm btn-secondary cancel-runner-btn ms-1">Cancel</button>';
            tr.querySelector('.cancel-runner-btn').addEventListener('click', function() { cancelEdit(tr); });
        });
    }

    function attachRowHandlers(tr) {
        var editBtn = tr.querySelector('.edit-runner-btn');
        if (editBtn) editBtn.addEventListener('click', function(e) { e.stopPropagation(); enterEditMode(tr); });
        tr.addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('input') || e.target.closest('select')) return;
            if (!tr.classList.contains('editing')) enterEditMode(tr);
        });
    }

    table.querySelectorAll('tbody tr.runner-row').forEach(attachRowHandlers);

    var addRunnerModal = document.getElementById('addRunnerModal');
    var addRunnerForm = document.getElementById('add-runner-form');
    var addRunnerSubmit = document.getElementById('add-runner-submit');
    var addRunnerErrors = document.getElementById('add-runner-errors');
    if (addRunnerModal && addRunnerForm && addRunnerSubmit) {
        addRunnerSubmit.addEventListener('click', function() {
            var first = (document.getElementById('add-first-name') && document.getElementById('add-first-name').value) || '';
            var last = (document.getElementById('add-last-name') && document.getElementById('add-last-name').value) || '';
            var email = (document.getElementById('add-email') && document.getElementById('add-email').value) || '';
            var age = (document.getElementById('add-age') && document.getElementById('add-age').value) || '';
            var genderEl = document.getElementById('add-gender');
            var gender = genderEl && genderEl.value ? genderEl.value : null;
            var numberEl = document.getElementById('add-number');
            var number = numberEl && numberEl.value !== '' ? parseInt(numberEl.value, 10) : null;
            if (number !== null && isNaN(number)) number = null;
            var typeEl = document.getElementById('add-type');
            var runnerType = typeEl && typeEl.value ? typeEl.value : null;
            var shirtEl = document.getElementById('add-shirt-size');
            var shirt = shirtEl ? shirtEl.value : '';
            addRunnerErrors.classList.add('d-none');
            addRunnerErrors.textContent = '';
            addRunnerSubmit.disabled = true;
            addRunnerSubmit.textContent = 'Adding…';
            fetch(addRunnerUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf(), 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({
                    race_id: currentRaceId,
                    first_name: first.trim(),
                    last_name: last.trim(),
                    email: email.trim(),
                    age: age,
                    gender: gender,
                    number: number,
                    type: runnerType,
                    shirt_size: shirt
                }),
                credentials: 'same-origin'
            }).then(function(r) { return r.json(); }).then(function(data) {
                addRunnerSubmit.disabled = false;
                addRunnerSubmit.textContent = 'Add Runner';
                if (data.success && data.runner) {
                    var r = data.runner;
                    var tbody = table.querySelector('tbody');
                    var tr = document.createElement('tr');
                    tr.className = 'runner-row';
                    tr.setAttribute('data-runner-id', r.id);
                    tr.setAttribute('data-first-name', r.first_name || '');
                    tr.setAttribute('data-last-name', r.last_name || '');
                    tr.setAttribute('data-email', r.email || '');
                    tr.setAttribute('data-age', r.age || '');
                    tr.setAttribute('data-gender', r.gender || '');
                    tr.setAttribute('data-number', r.number != null ? r.number : '');
                    tr.setAttribute('data-type', r.type || '');
                    tr.setAttribute('data-shirt-size', r.shirt_size || '');
                    tr.innerHTML =
                        '<td class="name-cell">' + escapeHtml(((r.first_name || '') + ' ' + (r.last_name || '')).trim() || '—') + '</td>' +
                        '<td class="age-cell">' + escapeHtml(r.age || '—') + '</td>' +
                        '<td class="number-cell">' + (r.number != null ? escapeHtml(String(r.number)) : '—') + '</td>' +
                        '<td class="type-cell">' + escapeHtml(r.type || '—') + '</td>' +
                        '<td class="shirt-cell">' + escapeHtml(r.shirt_size || '') + '</td>' +
                        '<td class="actions-cell"><button type="button" class="btn btn-sm btn-outline-primary edit-runner-btn" aria-label="Edit runner">Edit</button></td>';
                    tbody.appendChild(tr);
                    attachRowHandlers(tr);
                    var modal = bootstrap.Modal.getInstance(addRunnerModal);
                    if (modal) modal.hide();
                    addRunnerForm.reset();
                } else {
                    var msg = (data.errors && data.errors.length) ? data.errors.join(' ') : 'Failed to add runner';
                    addRunnerErrors.textContent = msg;
                    addRunnerErrors.classList.remove('d-none');
                }
            }).catch(function() {
                addRunnerSubmit.disabled = false;
                addRunnerSubmit.textContent = 'Add Runner';
                addRunnerErrors.textContent = 'Network error. Please try again.';
                addRunnerErrors.classList.remove('d-none');
            });
        });
    }

    var headers = table.tHead.querySelectorAll('th.sortable-th');
    var sortDir = 1;
    var sortCol = 0;
    headers.forEach(function(th, colIdx) {
        th.addEventListener('click', function() {
            sortDir = (sortCol === colIdx) ? -sortDir : 1;
            sortCol = colIdx;
            var tbody = table.querySelector('tbody');
            var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
            rows.sort(function(a, b) {
                var av = (a.cells[colIdx] && a.cells[colIdx].textContent) ? a.cells[colIdx].textContent.trim() : '';
                var bv = (b.cells[colIdx] && b.cells[colIdx].textContent) ? b.cells[colIdx].textContent.trim() : '';
                return sortDir * av.localeCompare(bv, undefined, { numeric: true });
            });
            rows.forEach(function(r) { tbody.appendChild(r); });
        });
    });
})();
</script>
<style>
.sortable-th:hover { cursor: pointer; }
.sortable-th.sorted_asc::after { content: " \2191"; }
.sortable-th.sorted_desc::after { content: " \2193"; }
.runner-row { cursor: pointer; }
.runner-row.editing { cursor: default; }
.runner-row.editing .name-cell { min-width: 180px; }
</style>
{% endblock %}
